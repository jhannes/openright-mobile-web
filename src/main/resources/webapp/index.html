<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Openright visual chat</title>
  <link rel="stylesheet" href="styles/mobile-app.css"/>
  <link rel="stylesheet" href="styles/font-awesome.min.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#333388">
  <link rel="icon" sizes="192x192" href="images/app-icon-192px.png">
</head>
<body>
  <header>
    <h1>Openright visual chat</h1>
  </header>
  <nav>
    <ul>
      <li><a href="#chats"><i class="fa fa-comments fa-2x"></i></a></li>
      <li><a href="#camera"><i class="fa fa-comment-o fa-2x"></i></a></li>
      <li><a href="#settings"><i class="fa fa-cogs fa-2x"></i></a></li>
    </ul>
  </nav>
  <main>
  </main>
  <section id="article-base">
    <article id="chats">
      <div class="message">
        <div class="message__header">
          <img src="images/svg/lizards.svg" width="100" alt=""/>
          <h2>Johannes Brodwall</h2>
          <p class="timeago" title="2015-06-01T20:54:17Z">3 minutes ago</p>
        </div>
        <div class="message__body">
          <img class="full-image" src="images/picture1.jpg">
        </div>
      </div>
      <div class="message">
        <div class="message__header">
          <img src="images/svg/shell.svg" width="100" alt=""/>
          <h2>Event Host</h2>
          <p class="timeago" title="2015-06-01T09:11:12Z">13 minutes ago</p>
        </div>
        <div class="message__body">
          <img class="full-image" src="images/picture2.jpg">
        </div>
      </div>
    </article>
    <article id="camera" onshow="showCamera()">
      <div class="card" id="camera__viewfinder">
        <div class="card__header">
          Send a picture
        </div>
        <div class="card__body" id="camera__video">
          <video autoplay height="200px" width="250px"></video>
          <canvas style="display: none"></canvas>
          <p><label>
            <input id="camera__include_location" type="checkbox" onchange="showLocation()">Include my location
          </label></p>
        </div>
        <div>
          <button id="camera__captureButton" disabled>Capture picture</button>
        </div>
      </div>
      <div class="card" id="camera__confirm">
        <div class="card__header">
          Preview
        </div>
        <div class="card__body">
          <img height="200px" id="camera__picture" />
          <button id="camera__sendButton" onclick="sendPicture()">Send</button>
          <button id="camera__retryButton" onclick="showCamera()">Retry</button>
        </div>
      </div>
    </article>
    <article id="settings">
      <div>
        <label>Name: <input type="text"/></label>
      </div>
      <div>
        <a href="#avatar">Capture avatar picture</a>
      </div>
      <div>
        <label>Include location: <input type="checkbox"/></label>
      </div>
    </article>
    <article id="avatar">
      <div>
        <label>
          Capture avatar picture
          <input type="file" id="avatar-picture" accept="image/*">
        </label>
      </div>
    </article>
    <article id="about">
      <div class="card">
        <div class="card__header">
          Mobile Web Showcase
        </div>
        <p class="card__body">
          This application shows a number of neat features of mobile web
        </p>
      </div>
      <div class="card">
        <p class="card__body">
          Styling for a mobile look and feel, installing on the home screen
        </p>
      </div>
      <div class="card">
        <p class="card__body">
          Camera controls in web pages
        </p>
      </div>
      <div class="card">
        <p class="card__body">
          Offline support (and offline detection)
        </p>
      </div>
      <div class="card">
        <p class="card__body">
          Push messages
        </p>
      </div>
      <div class="card">
        <p class="card__body">
          Vibration
        </p>
      </div>
    </article>
  </section>
  <footer>
    <h3>By Johannes Brodwall (<a href="#about">about</a>)</h3>
  </footer>

<script src="scripts/vendor/jquery-2.1.4.min.js"></script>
<script src="scripts/vendor/jquery.timeago.js" type="text/javascript"></script>
<script>
navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate
        || function() { console.log("I would normally vibrate..."); };
navigator.getUserMedia = navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia ||
        function(options, callback, errorHandler) { errorHandler("getUserMedia not supported"); };

$(function() {
  var $main = $("main");

  $(".timeago").timeago();

  function displayCurrentLocation() {
    $("nav li").removeClass("active");
    $main.fadeOut(500).hide(function() {
      window.scrollTo(0, 0);
      $main.html($(window.location.hash).clone());
      $main.fadeIn(1000);
      $("nav li a[href=" + window.location.hash + "]")
              .closest("li").addClass("active");

      if ($main.find($(window.location.hash)).attr("onshow")) {
        eval($main.find($(window.location.hash)).attr("onshow"));
      }
    });
  }

  if (!window.location.hash) {
    window.location.hash = "#chats";
  }
  $(window).bind('hashchange', displayCurrentLocation);
  displayCurrentLocation();
});

  function sendPicture() {
    // camera__include_location
    // camera__picture
    var camera = document.querySelector("#camera");
    console.log("location", camera.querySelector("#camera__include_location").checked);
    console.log("location", camera.querySelector("#camera__include_location").dataset.longitude);
    console.log("location", camera.querySelector("#camera__include_location").dataset.latitude);
    console.log("picture", camera.querySelector("#camera__picture").src);
    window.location.hash = "#chats";
  }

  function previewCamera(cameraId) {
    navigator.getUserMedia({video: { optional: [{sourceId: cameraId}] } }, function(stream) {
      var camera = document.querySelector("#camera");
      var video = camera.querySelector("video");
      video.src = window.URL.createObjectURL(stream);
      var captureButton = camera.querySelector("#camera__captureButton");
      captureButton.disabled = false;
      captureButton.onclick  = function() {
        var canvas = camera.querySelector("canvas");
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        camera.querySelector("#camera__picture").src = canvas.toDataURL('image/png');
        $(camera.querySelector(".card")).hide();
        $(camera.querySelector("#camera__confirm")).show();
        navigator.vibrate([100, 100, 100, 100, 100]);
      };
    }, function errorHandler(error) {
      console.error(error);
    });
  }

  function showCamera() {
    var $camera = $("#camera");
    $camera.find(".card:not(:first)").hide();
    $camera.find(".card:first").show();

    MediaStreamTrack.getSources(function(sources) {
      var videoSources = sources.filter(function(s) { return s.kind === "video"; });

      if (videoSources.length > 1) {
        videoSources.forEach(function(s) {
          if (s.facing) {
            $camera.find("#camera__video").append(
                    $("<button>").text(s.facing).click(function() { previewCamera(s.id); }));
          }
        });
      }
      previewCamera(videoSources[0].id);
    });
  }

  function showLocation() {
    var camera = document.querySelector("#camera");
    var location = camera.querySelector("#camera__include_location");
    if (location.checked) {
      location.checked = false;
      navigator.geolocation.getCurrentPosition(function(l) {
        location.checked = true;
        location.dataset.longitude = l.coords.longitude;
        location.dataset.latitude = l.coords.latitude;
      });
    }
  }
</script>
</body>
</html>
